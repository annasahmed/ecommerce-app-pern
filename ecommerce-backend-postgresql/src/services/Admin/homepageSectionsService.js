const db = require('../../db/models');

async function createSection(req) {
	const data = req.body;
	const maxPosition = await db.homepage_sections.max('position');

	return db.homepage_sections.create({
		...data,
		position: maxPosition ? maxPosition + 1 : 1,
	});
}

async function updateSection(req) {
	const data = req.body;
	const { sectionId } = req.params;
	const section = await db.homepage_sections.findByPk(sectionId);
	if (!section) throw new Error('Section not found');

	return section.update(data);
}

async function getHomepageSections(req) {
	const sections = await db.homepage_sections.findAll({
		where: { status: true },
		order: [['position', 'ASC']],
		raw: true,
	});

	// return sections
	if (!sections.length) return [];
	const mediaIds = new Set();
	for (const section of sections) {
		const config = section.config || {};

		// Slider
		if (Array.isArray(config.images)) {
			config.images.forEach((id) => mediaIds.add(id));
		}

		// Banner
		if (config.image) {
			mediaIds.add(config.image);
		}
	}

	// 3. Fetch media in bulk
	const [media] = await Promise.all([
		mediaIds.size
			? db.media.findAll({
					where: { id: [...mediaIds] },
					attributes: ['id', 'url'],
			  })
			: [],
	]);

	// 4. Create lookup maps
	const mediaMap = Object.fromEntries(media.map((m) => [m.id, m]));

	// 5. Hydrate sections (THIS IS THE MAGIC)
	const hydratedSections = sections.map((section) => {
		const config = { ...section.config };

		// Slider images
		if (Array.isArray(config.images)) {
			config.imagesUrl = config.images
				.map((id) => mediaMap[id])
				.filter(Boolean);
		}

		// Banner image
		if (config.image) {
			config.imageUrl = mediaMap[config.image] || null;
		}

		return {
			id: section.id,
			type: section.type,
			title: section.title,
			position: section.position,
			config,
		};
	});

	return hydratedSections;
}

async function deleteSection(req) {
	const { sectionId } = req.params;
	return db.homepage_sections.destroy({ where: { id: sectionId } });
}

async function reorderSections(payload) {
	const transaction = await db.sequelize.transaction();
	try {
		for (const item of payload) {
			await db.homepage_sections.update(
				{ position: item.position },
				{ where: { id: item.id }, transaction }
			);
		}
		await transaction.commit();
		return true;
	} catch (err) {
		await transaction.rollback();
		throw err;
	}
}

module.exports = {
	createSection,
	updateSection,
	getHomepageSections,
	deleteSection,
	reorderSections,
};
